# 系统帮助说明
---



## 设计

参见设计文档。

## 环境

### OS

```bash
➜  ~ uname -a
Linux ubuntu 3.13.0-32-generic #57-Ubuntu SMP Tue Jul 15 03:51:08 UTC 2014 x86_64 x86_64 x86_64 GNU/Linux
```

### SDN

**1. Open vSwitch**

```bash
➜  ~ sudo ovs-vsctl --version
ovs-vsctl (Open vSwitch) 2.3.2
Compiled Feb 25 2016 00:59:19
DB Schema 7.6.2
```

**2. SDN Controller： POX**

### 测试数据集

* Linux kernel的100个版本
* redis server的37个版本


## 系统主要功能

* 文件上传
* 网络中SDN控制器重复数据检测
* 服务器端存储文件，索引构建

## 运行

* 启动OVS，（start_ovs.sh）

```bash
➜  openvswitch-2.3.2 cat start_ovs.sh  
sudo make
sudo make install
sudo make modules_install
sudo /sbin/modprobe openvswitch 
/sbin/lsmod | grep "openvswitch"
sudo mkdir -p /usr/local/etc/openvswitch
sudo ovsdb-tool create /usr/local/etc/openvswitch/conf.db vswitchd/vswitch.ovsschema
sudo ovsdb-server --remote=punix:/usr/local/var/run/openvswitch/db.sock \
                     --remote=db:Open_vSwitch,Open_vSwitch,manager_options \
                     --private-key=db:Open_vSwitch,SSL,private_key \
                     --certificate=db:Open_vSwitch,SSL,certificate \
                     --bootstrap-ca-cert=db:Open_vSwitch,SSL,ca_cert \
                     --pidfile --detach
sudo  ovs-vsctl --no-wait init
sudo ovs-vswitchd --pidfile --detach
```

* 启动redis server， POX controller需要，缓存指纹

```bash
cd redis-3.0.5/     # before sdn controller start redis server

./src/redis-server # if change maxmemory config, then ./redis-server redis.conf
```

* 启动POX，指定我们实现的模块 pox.dedu.dedupe06

```bash
cd pox/			# start sdn controller

./pox.py log.level --DEBUG pox.dedu.dedupe06
```

* 启动Mininet

```bash
cd mininet/    
sh start_mn.sh

iperf h1 h10

```

* 修改流表

```bash
./init_flow_15_switches.sh    # add flows to switch use bash !!
```

* 编译client，server

```bash
cd source-dedu/   # compile
sh make10.sh
```

* 在Mininet的两个host中分别运行client，server

```bash
h15 ./server10  &  # start backup server
h1 ./client09  h15 <dataset>    # client backup a version
```

* 备份完成后，统计信息

```bash
➜  SdnBasedDeduplication : cd test              
➜  test : python extract_log.py 
Enter file name: kernel_sdna_cache_800k
--------------------------dedu time-------------------
[4.008264, 3.943874, 4.339101, 3.975689, 3.926724, 3.859574, 4.778007, 4.488389, 4.231914, 4.418918, 4.195945, 4.702788, 5.734566, 4.580693, 4.499628, 4.762909, 5.24696, 4.846964, 5.663082, 4.968633, 5.272255, 4.695161, 4.866314, 4.695586, 4.698431, 4.963016, 5.658102, 4.764334, 4.988954, 4.614567, 4.846316, 4.713139, 5.688324, 15.445399, 27.535297, 20.677558, 19.383036, 21.324289, 18.953932, 19.879203, 20.010588, 17.28086, 18.208451, 19.364916, 34.864549, 17.138319, 18.326486, 18.667829, 19.465755, 20.262784, 20.249425, 20.318964, 21.874531, 24.074825, 24.820009, 33.118647, 23.71087, 21.666799, 23.944867, 22.526474, 26.710171, 28.052541, 26.314192, 27.369413, 26.237364, 26.938115, 35.9486, 33.591101, 34.180185, 32.81941, 33.208255, 35.12703, 31.673467, 35.718749, 33.877988, 37.123852, 47.18931, 36.929817, 41.259977, 44.581518, 56.894743, 60.041606, 60.394941, 69.795629, 51.483234, 47.983144, 48.390903, 48.424277, 47.338305, 47.171521, 48.308821, 48.362543, 46.641551, 56.00155, 48.724354, 55.599379, 54.392824, 57.586435, 47.300062, 47.578204]
--------------------------file count------------------
[561, 598, 603, 608, 620, 637, 667, 671, 676, 688, 690, 707, 711, 729, 740, 766, 783, 795, 860, 868, 886, 890, 898, 905, 905, 907, 908, 908, 909, 909, 909, 908, 991, 1943, 1119, 1121, 1121, 1122, 1123, 1125, 1134, 1134, 1141, 1145, 1003, 1153, 1163, 1178, 1209, 1214, 1213, 1215, 1248, 1314, 1357, 1059, 1363, 1370, 1392, 1394, 1410, 1439, 1449, 1454, 1454, 1458, 1064, 1507, 1568, 1576, 1582, 1600, 1600, 1625, 1633, 1642, 1642, 1102, 1645, 1661, 1925, 1933, 1937, 2017, 2020, 2021, 2021, 2021, 2024, 2026, 2031, 2031, 2031, 2021, 2039, 2124, 2175, 2301, 2347, 2351]
---------------------------file new count-------------
[0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 2, 1, 0, 0, 0, 0, 1, 2, 1, 0, 0, 3, 0, 1, 13, 22, 8, 5, 11, 4, 4, 10, 2, 7, 13, 6, 9, 9, 8, 10, 15, 11, 14, 24, 17, 16, 8, 12, 5, 10, 9, 18, 17, 12, 20, 10, 16, 12, 35, 35, 18, 22, 22, 6, 21, 16, 17, 37, 13, 14, 17, 35, 17, 14, 160, 28, 15, 12, 6, 15, 13, 24, 23, 16, 42, 47, 111, 110, 171, 67, 104]
----------------------------file new count from pox---
[561, 319, 202, 96, 102, 63, 328, 187, 146, 142, 16, 139, 140, 129, 97, 96, 233, 119, 212, 138, 266, 91, 129, 89, 75, 130, 165, 18, 34, 15, 15, 9, 307, 1806, 597, 79, 79, 195, 120, 148, 190, 64, 146, 187, 58, 103, 118, 185, 194, 223, 182, 118, 204, 169, 130, 74, 95, 69, 111, 34, 193, 171, 99, 111, 80, 85, 120, 232, 217, 146, 82, 135, 31, 117, 33, 96, 204, 40, 41, 67, 212, 85, 44, 566, 99, 78, 32, 38, 50, 51, 56, 68, 45, 116, 98, 303, 240, 377, 158, 192]
----------------------------average dedu ratio--------
0.852354046734
```


## 参数配置

### 配置client/server的去重方法

```bash
$ ./client <server_ip_addr> [base/bloom/sdna] <backup_dir>
$ ./server -m [bloom/sdna]
```


### Bloom Filter大小

需要在程序中修改，server, SDN Controller 

### Cache大小

修改SDN Controller使用的redis server的内存配置(redis.conf)，maxmemory以及替换策略

```bash
maxmemory 1MB
maxmemory-policy allkeys-lru
```

### 带宽大小

在启动Mininet时候配置, bw带宽，delay时延

```bash
sudo mn --topo=linear,20 --link tc,bw=1000,delay=1ms --mac --switch=ovsk --controller=remote,ip=127.0.0.1
```

### 网络规模

在启动Mininet时候配置,配置OVS个数

```bash
sudo mn --topo=linear,40 --link tc,bw=1000,delay=1ms --mac --switch=ovsk --controller=remote,ip=127.0.0.1
```



## 性能测试结果

* 三种去重方法备份时间

```python
bloom_time = (35.765523, 26.453468, 22.883979, 21.731732, 22.489979, 21.537492, 31.929076, 27.855623, 25.235594, 31.46871, 21.673251, 26.401616, 26.691423, 26.908995, 26.147263, 31.852807, 33.613421, 28.404776, 33.978788, 29.987875, 36.644197, 30.184784, 31.779378, 31.011205, 30.615092, 29.416486, 31.236977, 27.513617, 28.700867, 27.873964, 28.68733, 28.766479, 38.908027, 123.719097, 57.091459, 37.475081, 37.238067, 38.703803, 35.885004, 37.854918, 41.520075, 36.438873, 39.907921, 42.896529, 30.644142, 38.992989, 39.924861, 42.630125, 41.132352, 42.104291, 43.584525, 41.858552, 45.797388, 45.954885, 46.310976, 35.023156, 45.374516, 44.630735, 43.150214, 41.102226, 48.21789, 50.551962, 48.042553, 49.153552, 43.728516, 43.888186, 34.308481, 54.830146, 56.279654, 53.347396, 47.887271, 49.786399, 46.763056, 54.228268, 51.565933, 53.796634, 53.360697, 35.23872, 52.366571, 53.745246, 63.7343, 57.264509, 56.021158, 87.566837, 65.929354, 64.886088, 58.182285, 58.30802, 61.780722, 62.011971, 62.641529, 61.526226, 59.157385, 64.952838, 65.156069, 72.930617, 72.068779, 86.590031, 77.115298, 77.262428)

base_time = (36.472232, 25.987929, 23.078874, 20.864176, 20.846923, 20.270137, 30.655572, 25.734055, 24.303996, 23.849385, 19.71688, 24.462919, 25.66142, 26.087848, 23.465361, 24.92781, 30.255095, 27.029679, 33.429959, 30.16152, 35.062737, 29.245125, 30.840968, 28.316153, 26.973532, 29.275257, 31.916621, 27.212067, 27.849805, 27.17662, 27.239185, 26.546269, 38.330348, 120.045155, 54.922068, 35.794599, 35.624218, 39.539473, 35.882229, 37.36693, 39.226453, 35.414437, 37.453504, 38.223526, 29.991451, 35.800448, 38.471165, 41.037814, 42.560892, 43.676489, 40.141728, 38.182144, 42.360779, 44.332152, 44.993798, 33.967103, 43.890992, 41.506034, 42.812854, 40.400168, 48.83646, 48.906084, 46.505769, 47.317855, 43.489562, 43.965174, 35.670307, 53.165105, 54.588559, 51.761723, 49.952956, 49.780498, 46.116245, 49.630142, 49.743781, 51.488446, 53.347219, 32.499874, 50.486973, 51.732847, 64.874359, 58.389157, 56.253052, 85.202473, 63.939903, 60.047517, 58.93463, 61.523489, 61.960436, 62.064308, 62.717551, 60.067668, 59.127409, 63.520667, 65.061792, 77.105049, 75.188786, 82.202873, 72.161324, 79.165279)
sdna_time  = [3.52194, 3.326431, 3.422871, 3.630502, 3.222517, 3.230395, 4.210521, 3.924686, 4.203968, 4.338076, 3.841369, 4.690643, 4.596318, 4.444491, 3.863757, 4.090796, 4.470908, 4.017424, 4.948002, 4.68503, 4.871497, 4.487968, 5.694021, 5.707382, 5.889879, 6.015573, 6.105161, 5.448093, 6.17433, 5.235259, 5.589878, 6.03994, 5.485664, 15.109012, 8.887594, 6.172025, 6.101093, 7.123986, 6.064062, 6.267095, 6.96048, 5.749672, 6.460605, 8.226885, 6.127437, 7.444641, 7.418043, 8.111957, 7.400765, 7.590226, 7.273604, 7.126262, 7.91503, 7.758239, 7.654032, 6.871301, 8.743946, 8.14937, 9.434864, 8.731709, 10.125483, 9.941248, 9.517718, 9.970281, 7.869458, 7.932473, 6.150183, 10.733488, 9.980461, 9.084119, 11.012918, 10.489933, 9.584832, 10.718879, 8.534527, 9.179512, 11.209295, 7.234235, 10.375859, 10.803705, 13.447527, 12.605586, 11.973166, 22.163557, 11.319466, 10.986806, 10.218841, 10.042426, 10.888059, 10.912685, 11.423053, 11.422885, 10.895553, 12.792907, 13.320633, 20.37959, 21.436388, 27.332503, 18.464939, 21.843313]
```

* Bloom filter 大小影响备份时间
* cache大小影响备份时间
* 带宽大小影响备份时间
* 网络规模影响备份时间
* 重删率
* 开销（查看流表的matches个数）

注：绘图使用matplotlib


## 性能分析

* 与传统源端去重相比，sdna明显减小备份时间
* Bloom filter过小，发生false positive的概率升高，使得SDN控制器重复数据检测效果不明显
* cache太小同样会使得备份时间增加
* 在低带宽环境下，sdna备份时间的减小更加明显
* 重删率有稍微的下降，由于Bloom filter的false negative


## 运行截图

![](result-imags/run.jpg)







